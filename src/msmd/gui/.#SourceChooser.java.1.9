package msmd.gui;

import java.util.*;
import javax.swing.*;
import javax.swing.border.*;
import java.awt.*;
import java.awt.event.*;
import java.io.IOException;
import msmd.*;

/**
 *  Description of the Class
 *
 * @author     ian
 * @created    October 10, 2002
 */
public class SourceChooser extends WizardPage implements ActionListener {

  protected JTextField fname;
  protected JButton browse;
  protected Wizard w;
  protected JPanel editPanel;
  protected JLabel editLabel;
  protected JButton launchEditor;


  SourceChooser(Wizard w) {
    this.w = w;
    setLayout(new BoxLayout(this, BoxLayout.Y_AXIS));
    browse = new JButton("Browse...");
    fname = new JTextField(40);
    add(Box.createVerticalGlue());
    JPanel pan = new JPanel();
    pan.setBorder(BorderFactory.createTitledBorder(BorderFactory.createLineBorder(Color.gray), "Select Example Page"));
    pan.add(fname);
    pan.add(browse);
    add(pan);
    add(Box.createVerticalGlue());
    editPanel = new JPanel();
    editPanel.setLayout(new BoxLayout(editPanel, BoxLayout.Y_AXIS));
    editPanel.setBorder(BorderFactory.createTitledBorder(BorderFactory.createLineBorder(Color.gray), "Edit Page"));
    editLabel = new JLabel("<html><p>You should now make the changes to the example page you have selected using your " +
        "favorite HTML editor, and save them.  You will not be able to go to the next step until " +
        "the modified page has been saved.</p></html>");
    launchEditor = new JButton("Launch Editor");
    launchEditor.setEnabled(false);
    editLabel.setForeground(Color.GRAY);
    editPanel.add(editLabel);
    add(editPanel);
    add(Box.createVerticalGlue());
    browse.addActionListener(this);
    browse.setActionCommand("original");
  }


  public String getTitle() {
    return "Step 1:  Training";
  }


  public boolean nextAllowed() {
    return ((w.properties.get("orig-dom") != null) &&
        ((DraftFile) w.properties.get("orig-df")).draftWasModified());
  }


  public void actionPerformed(ActionEvent e) {
    final JFileChooser chooser = new JFileChooser();
    // Note: source for ExampleFileFilter can be found in FileChooserDemo,
    // under the demo/jfc directory in the Java 2 SDK, Standard Edition.
    ExampleFileFilter filter = new ExampleFileFilter();
    filter.addExtension("html");
    filter.addExtension("htm");
    filter.setDescription("HTML Documents");
    chooser.setFileFilter(filter);
    int returnVal = chooser.showOpenDialog(this);
    if (returnVal == JFileChooser.APPROVE_OPTION) {
      try {
        fname.setText(chooser.getSelectedFile().getCanonicalPath());
        w.refresh();

          //Load the DOM in the background
          new Thread() {
            public void run() {
              try {
                System.err.println("Loading: " + chooser.getSelectedFile());

                w.properties.put("orig-dom", HTMLReader.readPage(chooser.getSelectedFile()));
                w.properties.put("orig-df", DraftFile.draftOf(chooser.getSelectedFile()));
                synchronized (w.properties) {
                  w.properties.notifyAll();
                }

                // Enable editing stuff
                launchEditor.setEnabled(true);
                editLabel.setForeground(Color.BLACK);

                // Start a timer to monitor for changes to draft file
                class CheckDFMod extends TimerTask {
                  java.util.Timer t;


                  public CheckDFMod(java.util.Timer t) {
                    this.t = t;
                  }


                  public void run() {
                    if (((DraftFile) w.properties.get("orig-df")).draftWasModified()) {
                      w.refresh();
                      t.cancel();
                    }
                  }
                }
                java.util.Timer t = new java.util.Timer();
                t.schedule(new CheckDFMod(t), 1000, 1000);
                System.err.println("Done loading.");
              } catch (IOException ie) {
                ie.printStackTrace();
              }
            }
          }.start();
      } catch (IOException ie) {
        ie.printStackTrace();
      }
    }
  }
}

